---
description: Безопасность — валидация, секреты, human-in-the-loop, least privilege
globs: backend/**/*.ts
alwaysApply: false
---

# Безопасность

## Валидация и санитизация

- Все **внешние входы** (тело запроса, query, params, загружаемые файлы) считай недоверенными.
- Используй **class-validator** для DTO: `@IsEmail()`, `@IsString()`, `@MinLength()`, `@IsUUID()`, `@IsOptional()` и т.д.
- В контроллерах подключай `ValidationPipe`. Не пропускай DTO без валидации.
- Санитизируй данные перед записью в БД (escape, нормализация). Не доверяй сырой ввод в raw-запросах.

## Секреты и чувствительные данные

- **Не хардкодить** API keys, пароли, токены. Использовать `ConfigService` / `.env`.
- **Не логировать** пароли, токены, сессии, PII. В логах — только идентификаторы (id), без секретов.
- В ответах API не возвращай `password`, `refreshToken` и подобное. Используй `@Exclude()` в entity или отдельные response-DTO.

## Human-in-the-loop

- **Опасные операции** (удаление данных, миграции БД, деплой, массовые изменения) — только после **явного подтверждения** пользователя.
- Не выполняй необратимые действия по умолчанию. Сначала опиши план и дождись одобрения.

## Least privilege

- Не давай агенту неограниченный shell. Выполняй только конкретные команды (например, `npm run test`, `npm run lint`, `nest build`).
- Не читай/не пиши вне проекта без явной необходимости. Не трогай `.env`, ключи, конфиги с секретами.

## Verification

- [ ] Входы валидируются через DTO + ValidationPipe.
- [ ] В логах и ответах нет паролей, токенов, PII.
- [ ] Опасные операции требуют подтверждения пользователя.
